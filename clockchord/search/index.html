<html>
<head>
<meta name="viewport" content="width=device-width">
<link rel="shortcut icon" href="../../midichordhelper.ico">
<title>ClockChord Songle Search</title>
<style>
	h1,h2,h3 { color:#FF6633; background-color:#FFFF99; }
	#search_result_container {
		margin-top: 8px;
		margin-bottom: 8px;
	}
	.small {
		font-size: 90%;
	}
	.song_hostname {
		color: gray;
		margin-left: 0.5em;
	}
</style>
</head>
<body onLoad="searchSongle();">
  <h1>ClockChord Songle Search</h1>
  <form>
    <div><input type="search" name="q"></input> <input type="submit" value="Search"></input></div>
  </form>
  <div id="search_result_container"></div>
  <div>
    <a href="https://camidion.wordpress.com/clockchord-songle-playlist/">Recommended songs</a>
    |
    <a href="https://kamide-akiyoshi.github.io/clockchord/">ClockChord</a>
    |
    <a href="https://songle.jp/" target="_blank">Songle</a>
  </div>
</body>
<script src="https://kamide-akiyoshi.github.io/clockchord/song_keys.js"></script>
<script>
const searchSongle = () => {
  const searchParams = new URLSearchParams(window.location.search);
  const keyword = searchParams.get("q");
  if( !keyword ) {
    return;
  }
  document.querySelector("input[type='search']").value = keyword;
  const resultContainer = document.getElementById("search_result_container");
  const getPageOption = (page) => page <= 1 ? null : `&page=${page}`;
  const page = parseInt(searchParams.get("page") ?? 1);
  const searchUrl = `https://widget.songle.jp/api/v1/songs/search.json?q=${encodeURIComponent(keyword)}${getPageOption(page) ?? ""}`;
  const statusElement = document.createElement("div");
  statusElement.textContent = "â³ Searching...";
  resultContainer.appendChild(statusElement);
  fetch(searchUrl).then((response) => {
    if( ! response.ok ) {
      return response;
    }
    return response.json();
  }).then((result) => {
    if( result instanceof Response ) {
      const { status, statusText } = result;
      if( status === 404 ) {
        statusElement.textContent = "Not Found";
        return;
      }
      const message = `HTTP error ${status}`;
      console.error(message, result);
      statusElement.textContent = message;
      return;
    }
    if( !Array.isArray(result) ) {
      const message = "Unexpected response format";
      console.error(message, result);
      statusElement.textContent = message;
      return;
    }
    statusElement.remove();
    if( page > 1 ) {
      const previous = document.createElement("a");
      previous.textContent = "â†‘Previous";
      previous.href = `?q=${keyword}${getPageOption(page - 1) ?? ""}`;
      resultContainer.appendChild(previous);
    }
    result.forEach((song) => {
      const { url, title, artist } = song;
      const encordedSongUrl = url.replace("https://songle.jp/songs/", "");
      const songUrl = decodeURIComponent(encordedSongUrl);
      const hasSongKey = typeof SONG_KEYS !== "undefined" && SONG_KEYS.has(songUrl);
      const line = document.createElement("div");
      if( hasSongKey ) {
        const keySpan = document.createElement("span");
        const label = "Song key available";
        keySpan.title = label;
        keySpan.ariaLabel = label;
        keySpan.textContent = "ðŸ”‘";
        line.appendChild(keySpan);
      }
      const songLink = document.createElement("a");
      songLink.href = `https://kamide-akiyoshi.github.io/clockchord/?url=${encordedSongUrl}`;
      songLink.textContent = title;
      line.appendChild(songLink);
      const bySpan = document.createElement("span");
      bySpan.textContent = " by ";
      bySpan.classList.add("small");
      const artistLink = document.createElement("a");
      artistLink.textContent = artist.name;
      artistLink.href = `https://songle.jp/artists/${artist.id}`;
      artistLink.target = "_blank";
      bySpan.appendChild(artistLink);
      line.appendChild(bySpan);
      const songSiteSpan = document.createElement("span");
      songSiteSpan.textContent = new URL(`https://${songUrl}`).hostname;
      songSiteSpan.classList.add("song_hostname");
      songSiteSpan.classList.add("small");
      line.appendChild(songSiteSpan);
      resultContainer.appendChild(line);
    });
    if( result.length >= 40 ) {
      const next = document.createElement("a");
      next.textContent = "â†“Next";
      next.href = `?q=${keyword}${getPageOption(page + 1) ?? ""}`;
      resultContainer.appendChild(next);
    }
  }).catch((error) => {
    statusElement.remove();
    console.error(error);
    alert("Search failed");
  });
};
</script>
</html>

