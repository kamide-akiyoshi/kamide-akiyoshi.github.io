<html>
<head>
<meta name="viewport" content="width=device-width">
<link rel="shortcut icon" href="../../midichordhelper.ico">
<title>ClockChord Songle Search</title>
<style>
	h1,h2,h3 { color:#FF6633; background-color:#FFFF99; }
	#search_result_container {
		margin-top: 8px;
		margin-bottom: 8px;
	}
	.small {
		font-size: 90%;
	}
	.song_hostname {
		color: gray;
		margin-left: 0.5em;
	}
	#songs {
		margin: 0.5em;
	}
	#songs > *:nth-child(odd) {
		background-color: #FFFFCC;
	}
	#songs .line_number {
		display: inline-block;
		width: 1.5em;
		text-align: end;
		margin-right: 0.5em;
	}
</style>
</head>
<body onLoad="searchSongle();">
  <h1>ClockChord Songle Search</h1>
  <div>üîçSearch the song registered on <a href="https://songle.jp/" target="_blank">Songle</a> to play on <a href="https://kamide-akiyoshi.github.io/clockchord/">ClockChord</a></div>
  <hr/>
  <form>
    <div>Enter keyword: <input type="search" name="q" required></input> <input type="submit" value="üîçSearch"></input></div>
  </form>
  <div id="search_result_container"></div>
  <hr/>
  <div>
    <a href="https://camidion.wordpress.com/clockchord-songle-playlist/">Recommended songs</a>
  </div>
</body>
<script src="https://kamide-akiyoshi.github.io/clockchord/song_keys.js"></script>
<script>
const searchSongle = () => {
  const searchParams = new URLSearchParams(window.location.search);
  const keyword = searchParams.get("q");
  if( !keyword ) {
    return;
  }
  document.querySelector("input[type='search']").value = keyword;
  const page = parseInt(searchParams.get("page") ?? 1);
  const resultContainer = document.getElementById("search_result_container");
  const statusElement = document.createElement("div");
  statusElement.textContent = "‚è≥ Searching...";
  resultContainer.appendChild(statusElement);
  const getPageOption = (page) => page <= 1 ? "" : `&page=${page}`;
  fetch(
    `https://widget.songle.jp/api/v1/songs/search.json?q=${encodeURIComponent(keyword)}${getPageOption(page)}`
  ).then((response) => {
    if( ! response.ok ) {
      const { status } = response;
      if( status === 404 ) {
        return "Not Found";
      }
      const message = `HTTP error ${status}`;
      console.error(message, response);
      return message;
    }
    statusElement.textContent = "‚è≥ Decoding...";
    return response.json();
  }).then((songs) => {
    if( typeof songs === "string" ) {
      statusElement.textContent = songs;
      return;
    }
    const MAX_SONGS_PER_PAGE = 40;
    const songsElement = document.createElement("div");
    songsElement.id = "songs";
    songs.forEach((song, index) => {
      const { url, title, artist } = song;
      const encordedSongUrl = url.replace("https://songle.jp/songs/", "");
      const songUrl = decodeURIComponent(encordedSongUrl);
      const hasSongKey = typeof SONG_KEYS !== "undefined" && SONG_KEYS.has(songUrl);
      const line = document.createElement("div");
      const numberSpan = document.createElement("span");
      numberSpan.textContent = `${(MAX_SONGS_PER_PAGE * (page - 1)) + index + 1}`;
      numberSpan.classList.add("line_number");
      line.appendChild(numberSpan);
      if( hasSongKey ) {
        const keySpan = document.createElement("span");
        const label = "Song key available";
        keySpan.title = label;
        keySpan.ariaLabel = label;
        keySpan.textContent = "üîë";
        line.appendChild(keySpan);
      }
      const songLink = document.createElement("a");
      songLink.href = `https://kamide-akiyoshi.github.io/clockchord/?url=${encordedSongUrl}`;
      songLink.textContent = title;
      line.appendChild(songLink);
      const bySpan = document.createElement("span");
      bySpan.textContent = " by ";
      bySpan.classList.add("small");
      const artistLink = document.createElement("a");
      artistLink.textContent = artist.name;
      artistLink.href = `https://songle.jp/artists/${artist.id}`;
      artistLink.target = "_blank";
      bySpan.appendChild(artistLink);
      line.appendChild(bySpan);
      const songSiteSpan = document.createElement("span");
      songSiteSpan.textContent = new URL(`https://${songUrl}`).hostname;
      songSiteSpan.classList.add("song_hostname");
      songSiteSpan.classList.add("small");
      line.appendChild(songSiteSpan);
      songsElement.appendChild(line);
    });
    const hasMore = songs.length >= MAX_SONGS_PER_PAGE;
    const songCountElement = document.createElement("div");
    songCountElement.textContent = `Page ${page} `;
    if( page > 1 ) {
      const previous = document.createElement("a");
      previous.id = "previous";
      previous.textContent = `‚ñ≤Previous`;
      previous.href = `?q=${keyword}${getPageOption(page - 1)}`;
      songCountElement.appendChild(previous);
    }
    resultContainer.appendChild(songCountElement);
    resultContainer.appendChild(songsElement);
    if( hasMore ) {
      const next = document.createElement("a");
      next.id = "next";
      next.textContent = "‚ñºNext";
      next.href = `?q=${keyword}${getPageOption(page + 1)}`;
      resultContainer.appendChild(next);
    }
    statusElement.remove();
  }).catch((error) => {
    const message = "Unexpected error";
    console.error(message, error);
    statusElement.textContent = message;
  });
};
</script>
</html>

